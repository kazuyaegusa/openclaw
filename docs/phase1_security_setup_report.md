# Phase 1 完了レポート: OpenClaw セキュリティ重視セットアップ

## 基本情報

| 項目     | 内容                                                |
| -------- | --------------------------------------------------- |
| 実施日   | 2026-02-12                                          |
| フェーズ | Phase 1: 環境構築・初期セットアップ                 |
| 実施者   | Claude Code (Opus 4.6) + ユーザー                   |
| 環境     | macOS 26.2 (Darwin 25.2.0), Apple M1 Max, 64 GB RAM |

## 概要

OpenClaw をソースからビルドし、セキュリティを最重視した設定でローカル環境に構築した。
LLM は Ollama (qwen2.5:14b) をローカル実行、TTS は Edge TTS（APIキー不要）を採用し、
外部サービスへの依存を最小化した。

## 実施内容

### 1. 環境準備

| コンポーネント     | バージョン              | 状態             |
| ------------------ | ----------------------- | ---------------- |
| Node.js            | v22.14.0                | 既存             |
| pnpm               | 10.23.0 (corepack 経由) | 更新済み         |
| Docker             | 24.0.7                  | 既存             |
| Ollama             | 0.13.5                  | 既存             |
| qwen2.5:14b モデル | Q4_K_M (9.0 GB)         | 新規ダウンロード |

### 2. OpenClaw ビルド

```
ソースリポジトリ: /Users/kazuyaegusa/KEWORK/OpenClaw/OpenClaw-repo/
バージョン: 2026.2.10
```

| ステップ        | 結果                                |
| --------------- | ----------------------------------- |
| `pnpm install`  | 991 パッケージインストール (36.1s)  |
| `pnpm ui:build` | Control UI ビルド成功 (764ms)       |
| `pnpm build`    | メインビルド成功 (598ms, 144 files) |

### 3. セキュリティ設定ファイル作成

| ファイル                            | パーミッション | 用途                   |
| ----------------------------------- | -------------- | ---------------------- |
| `~/.openclaw/openclaw.json`         | 600            | メイン設定             |
| `~/.openclaw/.env`                  | 600            | トークン・APIキー      |
| `~/.openclaw/workspace/AGENTS.md`   | 644            | エージェントプロンプト |
| `~/.openclaw/credentials/`          | 700            | 認証情報ディレクトリ   |
| `~/.openclaw/certs/`                | 700            | 証明書ディレクトリ     |
| `~/.openclaw/agents/main/sessions/` | 700            | セッションストア       |

### 4. セキュリティ設定詳細

| 設定項目                       | 値                              | セキュリティ効果                   |
| ------------------------------ | ------------------------------- | ---------------------------------- |
| `gateway.bind`                 | `loopback`                      | 127.0.0.1 のみ（外部アクセス不可） |
| `gateway.auth.mode`            | `token`                         | ランダムトークン認証必須           |
| `agents.defaults.sandbox.mode` | `non-main`                      | メイン以外は Docker 隔離           |
| チャネル                       | WebChat のみ                    | 外部サービス接続なし               |
| LLM                            | `ollama/qwen2.5:14b`            | ローカル実行（データ外部送信なし） |
| TTS                            | Edge TTS (`ja-JP-NanamiNeural`) | APIキー不要                        |
| トークン生成                   | `openssl rand -hex 32`          | 暗号学的に安全な256bit             |

## 検証結果

### ゲートウェイ起動確認

| 項目                | 結果                                                      |
| ------------------- | --------------------------------------------------------- |
| WebSocket リッスン  | `ws://127.0.0.1:18789` (IPv4) + `ws://[::1]:18789` (IPv6) |
| Control UI アクセス | `http://127.0.0.1:18789/openclaw/` → HTML 正常表示        |
| Ollama モデル認識   | `agent model: ollama/qwen2.5:14b`                         |
| 外部アクセス        | 接続拒否（正常）                                          |

### `openclaw doctor` 診断結果

| カテゴリ        | 結果                                       |
| --------------- | ------------------------------------------ |
| State integrity | セッションディレクトリ作成済み（修正済み） |
| Sandbox         | Docker 利用可能                            |
| Security        | チャネルセキュリティ警告なし               |
| Skills          | 有効: 10, 要件不足: 41                     |
| Plugins         | ロード: 4, 無効: 31, エラー: 0             |

### セキュリティチェックリスト

- [x] ゲートウェイは loopback バインド（127.0.0.1 のみ）
- [x] トークン認証を有効化（256bit ランダムトークン）
- [x] `.env` ファイルのパーミッション 600
- [x] credentials ディレクトリのパーミッション 700
- [x] 外部チャネル接続なし（WebChat のみ）
- [x] Docker サンドボックスを非メインセッションに適用
- [x] API キーはハードコードしない（環境変数経由）
- [x] 外部 IP からのアクセス不可を確認

## 未実施・今後の課題

| 項目                             | 理由                                  | 優先度 |
| -------------------------------- | ------------------------------------- | ------ |
| Homebrew インストール            | sudo 権限必要（ターミナルで手動実行） | 低     |
| OpenAI フォールバック設定        | APIキー未取得                         | 中     |
| Voice Wake (macOS アプリ)        | Xcode + Swift ビルド必要              | 低     |
| `openclaw security audit --deep` | ゲートウェイ稼働中に実行推奨          | 中     |
| テスト実行 (`pnpm test`)         | 環境セットアップのみのため未実施      | 低     |

## 次のフェーズへの申し送り

1. **ゲートウェイはバックグラウンドで稼働中** — PID 29954, `ws://127.0.0.1:18789`
2. **WebChat で動作テスト可能** — ブラウザで `http://127.0.0.1:18789/openclaw/` を開く
3. **OpenAI APIキー取得後** — `~/.openclaw/.env` の `OPENAI_API_KEY` を設定し、`openclaw.json` の `fallbacks` に追加
4. **スキル追加** — `openclaw skills search` / `openclaw skills install` で拡張可能
5. **既存 Claude Code スキル** — `~/.claude/skills/` は `skills.load.extraDirs` で参照設定済み
